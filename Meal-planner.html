<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anvil - Meal Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #051223;
            --bg-card: #0a1e35;
            --bg-elevated: #0f2847;
            --bg-hover: #143052;
            --border: #1a3a5c;
            --text-primary: #ffffff;
            --text-secondary: #a0b8d0;
            --text-muted: #6a8aa8;
            --accent: #4a7ab0;
            --accent-hover: #5a8ac4;
            --success: #32d74b;
            --warning: #ffd60a;
            --danger: #ff453a;
            --protein: #ff6b6b;
            --carbs: #ffd93d;
            --fats: #6bcb77;
            --fruit-veg: #4d96ff;
        }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), #3a6090);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
        }

        .logo-text {
            font-weight: 700;
            font-size: 20px;
            letter-spacing: -0.5px;
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .client-search-container {
            position: relative;
            min-width: 250px;
        }

        .client-search-input {
            width: 100%;
            padding: 10px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .client-search-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .client-search-input::placeholder {
            color: var(--text-muted);
        }

        .client-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }

        .client-dropdown.active {
            display: block;
        }

        .client-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.15s;
        }

        .client-dropdown-item:last-child {
            border-bottom: none;
        }

        .client-dropdown-item:hover {
            background: var(--bg-elevated);
        }

        .client-dropdown-item.selected {
            background: var(--accent);
        }

        .client-dropdown-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .client-dropdown-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .client-dropdown-item.selected .client-dropdown-meta {
            color: rgba(255,255,255,0.7);
        }

        .no-clients {
            padding: 16px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        .client-targets {
            display: flex;
            gap: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .target-item {
            padding: 4px 8px;
            background: var(--bg-elevated);
            border-radius: 4px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            padding: 10px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s;
        }

        .header-btn:hover {
            border-color: var(--text-muted);
        }

        .header-btn.primary {
            background: var(--accent);
            border-color: var(--accent);
        }

        .header-btn.primary:hover {
            background: var(--accent-hover);
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr 320px;
            height: calc(100vh - 69px);
        }

        /* Food Search Panel */
        .search-panel {
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .search-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-dark);
        }

        .search-box input::placeholder {
            color: var(--text-muted);
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 18px;
        }

        /* Category Filters */
        .category-filters {
            display: flex;
            gap: 6px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }

        .filter-btn {
            padding: 6px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .filter-btn:hover {
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        .filter-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Food List */
        .food-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .food-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 6px;
            cursor: grab;
            transition: all 0.15s;
        }

        .food-card:hover {
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .food-card:active {
            cursor: grabbing;
        }

        .food-card.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }

        .category-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .category-dot.protein { background: var(--protein); }
        .category-dot.carbs { background: var(--carbs); }
        .category-dot.fat { background: var(--fats); }
        .category-dot.fruit_veg { background: var(--fruit-veg); }
        .category-dot.dairy { background: #a78bfa; }
        .category-dot.other { background: var(--text-muted); }

        .food-info {
            flex: 1;
            min-width: 0;
        }

        .food-name {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .food-macros {
            display: flex;
            gap: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
        }

        .macro-value {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .macro-value span {
            font-weight: 500;
        }

        .macro-value.p span { color: var(--protein); }
        .macro-value.c span { color: var(--carbs); }
        .macro-value.f span { color: var(--fats); }

        /* Meal Builder Panel */
        .meal-builder {
            background: var(--bg-dark);
            padding: 20px;
            overflow-y: auto;
        }

        .day-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .day-tab {
            padding: 10px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .day-tab:hover {
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        .day-tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .add-day-btn {
            padding: 10px 16px;
            background: transparent;
            border: 1px dashed var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .add-day-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .day-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .day-title-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .day-title {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .day-type-badge {
            padding: 4px 12px;
            background: var(--bg-elevated);
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .day-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 14px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .action-btn:hover {
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        /* Add Meal Button */
        .add-meal-btn {
            width: 100%;
            padding: 16px;
            background: transparent;
            border: 2px dashed var(--border);
            border-radius: 14px;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 16px;
        }

        .add-meal-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Meal Card */
        .meal-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .meal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
        }

        .meal-title-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .meal-title {
            font-size: 14px;
            font-weight: 600;
        }

        .meal-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .meal-totals {
            display: flex;
            gap: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }

        .meal-totals .macro-value span {
            color: var(--text-primary);
        }

        .meal-actions {
            display: flex;
            gap: 4px;
        }

        .meal-action-btn {
            padding: 4px 8px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
        }

        .meal-action-btn:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        /* Drop Zone */
        .drop-zone {
            min-height: 60px;
            padding: 12px;
            transition: all 0.2s;
        }

        .drop-zone.drag-over {
            background: rgba(74, 122, 176, 0.1);
            border: 2px dashed var(--accent);
            border-radius: 10px;
            margin: 8px;
        }

        .drop-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 50px;
            border: 2px dashed var(--border);
            border-radius: 10px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .drop-zone.drag-over .drop-placeholder {
            display: none;
        }

        /* Column Headers */
        .meal-columns {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            gap: 8px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .col-header {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 6px 12px;
            background: var(--bg-dark);
            border-radius: 4px;
            text-align: center;
        }

        .col-food-header {
            flex: 1;
            min-width: 140px;
        }

        .col-amount-header {
            width: 80px;
        }

        .col-macros-header {
            width: 180px;
            display: flex;
            gap: 4px;
        }

        .col-macro-header {
            flex: 1;
            padding: 6px 8px;
            background: var(--bg-dark);
            border-radius: 4px;
            text-align: center;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .col-macro-header.p { color: var(--protein); }
        .col-macro-header.c { color: var(--carbs); }
        .col-macro-header.f { color: var(--fats); }

        .col-action-header {
            width: 24px;
        }

        /* Meal Item */
        .meal-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .meal-item:last-child {
            margin-bottom: 0;
        }

        .meal-item-food {
            flex: 1;
            min-width: 140px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-dark);
            border-radius: 6px;
        }

        .meal-item-name {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .meal-item-amount {
            width: 80px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            background: var(--bg-dark);
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
        }

        .meal-item-macros {
            width: 180px;
            display: flex;
            gap: 4px;
        }

        .meal-item-macro {
            flex: 1;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            padding: 8px 4px;
            background: var(--bg-dark);
            border-radius: 6px;
            text-align: center;
        }

        .meal-item-macro.p { color: var(--protein); }
        .meal-item-macro.c { color: var(--carbs); }
        .meal-item-macro.f { color: var(--fats); }

        .remove-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .remove-btn:hover {
            background: var(--danger);
            color: white;
        }

        /* Summary Panel */
        .summary-panel {
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .summary-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
        }

        /* Macro Progress */
        .macro-progress {
            margin-bottom: 24px;
        }

        .progress-item {
            margin-bottom: 16px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .progress-label {
            font-size: 13px;
            font-weight: 500;
        }

        .progress-values {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-dark);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-fill.kcal { background: var(--accent); }
        .progress-fill.protein { background: var(--protein); }
        .progress-fill.carbs { background: var(--carbs); }
        .progress-fill.fat { background: var(--fats); }
        .progress-fill.fibre { background: var(--accent); }
        .progress-fill.over { background: var(--danger); }

        /* Micro Section */
        .micro-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .micro-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .micro-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .micro-item {
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 8px;
        }

        .micro-item.good {
            border-left: 3px solid var(--success);
        }

        .micro-item.warning {
            border-left: 3px solid var(--warning);
        }

        .micro-item.low {
            border-left: 3px solid var(--danger);
        }

        .micro-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .micro-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 600;
        }

        .micro-target {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .modal-subtitle {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .modal-input-group {
            margin-bottom: 20px;
        }

        .modal-input-label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .modal-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: 'JetBrains Mono', monospace;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .modal-preview {
            background: var(--bg-elevated);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .modal-preview-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 14px;
        }

        .modal-preview-row:not(:last-child) {
            border-bottom: 1px solid var(--border);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .modal-cancel {
            flex: 1;
            padding: 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .modal-confirm {
            flex: 1;
            padding: 12px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .modal-confirm:hover {
            background: var(--accent-hover);
        }

        /* Day Type Modal */
        .day-type-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .day-type-option {
            padding: 16px;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
        }

        .day-type-option:hover {
            border-color: var(--accent);
        }

        .day-type-option.selected {
            border-color: var(--accent);
            background: rgba(74, 122, 176, 0.1);
        }

        .day-type-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .day-type-name {
            font-size: 14px;
            font-weight: 500;
        }

        /* Empty State */
        .empty-meals {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-meals-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-meals-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .empty-meals-text {
            font-size: 14px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">A</div>
            <span class="logo-text">Anvil</span>
        </div>

        <div class="header-center">
            <div class="client-search-container">
                <input type="text" class="client-search-input" id="clientSearchInput" placeholder="Search clients..." autocomplete="off">
                <div class="client-dropdown" id="clientDropdown">
                    <!-- Client list will be rendered here -->
                </div>
            </div>
            <div class="client-targets" id="clientTargets">
                <span class="target-item">No client selected</span>
            </div>
        </div>

        <div class="header-actions">
            <button class="header-btn" onclick="savePlan()">üíæ Save Plan</button>
            <button class="header-btn" onclick="exportPlan()">üì§ Export</button>
            <button class="header-btn" onclick="window.location.href='index.html'">‚Üê Dashboard</button>
        </div>
    </header>

    <div class="main-container">
        <!-- Food Search Panel -->
        <aside class="search-panel">
            <div class="search-header">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" placeholder="Search foods..." id="foodSearch">
                </div>
            </div>

            <div class="category-filters">
                <button class="filter-btn active" data-category="all">All</button>
                <button class="filter-btn" data-category="protein">Protein</button>
                <button class="filter-btn" data-category="carbs">Carbs</button>
                <button class="filter-btn" data-category="fat">Fats</button>
                <button class="filter-btn" data-category="fruit_veg">Fruit/Veg</button>
                <button class="filter-btn" data-category="dairy">Dairy</button>
            </div>

            <div class="food-list" id="foodList">
                <div style="padding: 20px; text-align: center; color: var(--text-muted);">Loading foods...</div>
            </div>
        </aside>

        <!-- Meal Builder -->
        <main class="meal-builder">
            <div class="day-tabs" id="dayTabs">
                <button class="day-tab active" data-day="1">Training Day</button>
                <button class="add-day-btn" onclick="openAddDayModal()">+ Add Day Type</button>
            </div>

            <div class="day-header">
                <div class="day-title-section">
                    <h1 class="day-title" id="dayTitle">Training Day</h1>
                    <span class="day-type-badge" id="dayTypeBadge">High Carb</span>
                </div>
                <div class="day-actions">
                    <button class="action-btn" onclick="clearDay()">Clear Day</button>
                    <button class="action-btn" onclick="copyDay()">Copy Day</button>
                </div>
            </div>

            <button class="add-meal-btn" onclick="addMeal()">+ Add Meal</button>

            <div id="mealsContainer">
                <!-- Meals will be rendered here -->
            </div>
        </main>

        <!-- Summary Panel -->
        <aside class="summary-panel">
            <h2 class="summary-title">Daily Totals</h2>

            <div class="macro-progress">
                <div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">Calories</span>
                        <span class="progress-values"><span id="total-kcal">0</span> / <span id="target-kcal">2500</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill kcal" id="progress-kcal" style="width: 0%"></div>
                    </div>
                </div>

                <div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">Protein</span>
                        <span class="progress-values"><span id="total-protein">0</span>g / <span id="target-protein">180</span>g</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill protein" id="progress-protein" style="width: 0%"></div>
                    </div>
                </div>

                <div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">Carbs</span>
                        <span class="progress-values"><span id="total-carbs">0</span>g / <span id="target-carbs">300</span>g</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill carbs" id="progress-carbs" style="width: 0%"></div>
                    </div>
                </div>

                <div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">Fat</span>
                        <span class="progress-values"><span id="total-fat">0</span>g / <span id="target-fat">80</span>g</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill fat" id="progress-fat" style="width: 0%"></div>
                    </div>
                </div>

                <div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">Fibre</span>
                        <span class="progress-values"><span id="total-fibre">0</span>g / <span id="target-fibre">35</span>g</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill fibre" id="progress-fibre" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="micro-section">
                <h3 class="micro-title">Micronutrients</h3>
                <div class="micro-grid" id="microGrid">
                    <!-- Micros will be rendered here -->
                </div>
            </div>
        </aside>
    </div>

    <!-- Quantity Modal -->
    <div class="modal-overlay" id="quantityModal">
        <div class="modal">
            <h3 class="modal-title" id="modalFoodName">Food Name</h3>
            <p class="modal-subtitle" id="modalFoodInfo">per 100g</p>
            
            <div class="modal-input-group">
                <label class="modal-input-label">Amount (grams)</label>
                <input type="number" class="modal-input" id="quantityInput" value="100" min="1" step="10">
            </div>

            <div class="modal-preview">
                <div class="modal-preview-row">
                    <span>Calories</span>
                    <span id="previewKcal">0 kcal</span>
                </div>
                <div class="modal-preview-row">
                    <span>Protein</span>
                    <span id="previewProtein">0g</span>
                </div>
                <div class="modal-preview-row">
                    <span>Carbs</span>
                    <span id="previewCarbs">0g</span>
                </div>
                <div class="modal-preview-row">
                    <span>Fat</span>
                    <span id="previewFat">0g</span>
                </div>
            </div>

            <div class="modal-actions">
                <button class="modal-cancel" onclick="closeQuantityModal()">Cancel</button>
                <button class="modal-confirm" onclick="confirmAddFood()">Add to Meal</button>
            </div>
        </div>
    </div>

    <!-- Add Day Type Modal -->
    <div class="modal-overlay" id="addDayModal">
        <div class="modal">
            <h3 class="modal-title">Add Day Type</h3>
            <p class="modal-subtitle">Create a new meal template</p>

            <div class="day-type-options">
                <div class="day-type-option selected" data-type="training">
                    <div class="day-type-icon">üèãÔ∏è</div>
                    <div class="day-type-name">Training Day</div>
                </div>
                <div class="day-type-option" data-type="rest">
                    <div class="day-type-icon">üò¥</div>
                    <div class="day-type-name">Rest Day</div>
                </div>
                <div class="day-type-option" data-type="double">
                    <div class="day-type-icon">üí™</div>
                    <div class="day-type-name">Double Session</div>
                </div>
                <div class="day-type-option" data-type="comp">
                    <div class="day-type-icon">üèÜ</div>
                    <div class="day-type-name">Competition Day</div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="modal-cancel" onclick="closeAddDayModal()">Cancel</button>
                <button class="modal-confirm" onclick="confirmAddDay()">Add Day</button>
            </div>
        </div>
    </div>

    <!-- Meal Name Modal -->
    <div class="modal-overlay" id="mealNameModal">
        <div class="modal">
            <h3 class="modal-title">Add Meal</h3>
            <p class="modal-subtitle">Name this meal</p>

            <div class="modal-input-group">
                <label class="modal-input-label">Meal Name</label>
                <input type="text" class="modal-input" id="mealNameInput" placeholder="e.g., Pre-Training, Dinner">
            </div>

            <div class="modal-input-group">
                <label class="modal-input-label">Time (optional)</label>
                <input type="time" class="modal-input" id="mealTimeInput">
            </div>

            <div class="modal-actions">
                <button class="modal-cancel" onclick="closeMealNameModal()">Cancel</button>
                <button class="modal-confirm" onclick="confirmAddMeal()">Add Meal</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://aurruayyeaggeiggzxnt.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Xf6PD6ZHVQVKV59X2-u2UQ_TESbj4AC';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // State
        let foods = [];
        let clients = [];
        let selectedClientId = null;
        let currentCategory = 'all';
        let currentSearch = '';
        let draggedFood = null;
        let targetMealIndex = null;
        let selectedDayType = 'training';

        // Day types with their configurations
        const dayTypes = {
            training: { name: 'Training Day', badge: 'High Carb', icon: 'üèãÔ∏è' },
            rest: { name: 'Rest Day', badge: 'Low Carb', icon: 'üò¥' },
            double: { name: 'Double Session', badge: 'High Carb', icon: 'üí™' },
            comp: { name: 'Competition Day', badge: 'Peak', icon: 'üèÜ' }
        };

        // Meal plans by day type
        let mealPlans = {
            training: { meals: [] },
            rest: { meals: [] },
            double: { meals: [] },
            comp: { meals: [] }
        };

        let currentDayType = 'training';

        // Targets (will be loaded from client)
        let targets = {
            kcal: 2500,
            protein: 180,
            carbs: 300,
            fat: 80,
            fibre: 35,
            iron: 14,
            calcium: 700,
            omega3: 1.6,
            vitaminD: 10,
            vitaminB12: 2.4,
            zinc: 11,
            magnesium: 400
        };

        // Load foods from Supabase
        async function loadFoods() {
            try {
                const { data, error } = await supabaseClient
                    .from('foods')
                    .select('*')
                    .order('name');

                if (error) throw error;
                foods = data || [];
                renderFoodList();
            } catch (error) {
                console.error('Error loading foods:', error);
                document.getElementById('foodList').innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">Error loading foods</div>';
            }
        }

        // Load clients from Supabase
        async function loadClients() {
            try {
                const { data, error } = await supabaseClient
                    .from('clients')
                    .select('*')
                    .eq('status', 'active')
                    .order('first_name');

                if (error) throw error;
                clients = data || [];
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        // Render client dropdown
        function renderClientDropdown(filter = '') {
            const dropdown = document.getElementById('clientDropdown');
            const filtered = clients.filter(c => 
                `${c.first_name} ${c.last_name}`.toLowerCase().includes(filter.toLowerCase()) ||
                (c.sport && c.sport.toLowerCase().includes(filter.toLowerCase()))
            );

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="no-clients">No clients found</div>';
                return;
            }

            dropdown.innerHTML = filtered.map(c => `
                <div class="client-dropdown-item ${c.id === selectedClientId ? 'selected' : ''}" data-client-id="${c.id}">
                    <div class="client-dropdown-name">${c.first_name} ${c.last_name}</div>
                    <div class="client-dropdown-meta">${c.sport || 'No sport'} ‚Ä¢ ${c.target_calories || '-'} kcal</div>
                </div>
            `).join('');

            // Add click handlers
            dropdown.querySelectorAll('.client-dropdown-item').forEach(item => {
                item.addEventListener('click', () => selectClient(item.dataset.clientId));
            });
        }

        // Client search input handlers
        const clientSearchInput = document.getElementById('clientSearchInput');
        const clientDropdown = document.getElementById('clientDropdown');

        clientSearchInput.addEventListener('focus', () => {
            renderClientDropdown(clientSearchInput.value);
            clientDropdown.classList.add('active');
        });

        clientSearchInput.addEventListener('input', (e) => {
            renderClientDropdown(e.target.value);
            clientDropdown.classList.add('active');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.client-search-container')) {
                clientDropdown.classList.remove('active');
            }
        });

        // Select client function
        function selectClient(clientId) {
            selectedClientId = clientId;
            const client = clients.find(c => c.id === clientId);
            
            if (client) {
                // Update input to show selected client
                clientSearchInput.value = `${client.first_name} ${client.last_name}`;
                clientDropdown.classList.remove('active');

                // Update targets from client
                targets.kcal = client.target_calories || 2500;
                targets.protein = client.target_protein || 180;
                targets.carbs = client.target_carbs || 300;
                targets.fat = client.target_fat || 80;
                targets.fibre = client.target_fibre || 35;

                // Update UI
                document.getElementById('target-kcal').textContent = targets.kcal;
                document.getElementById('target-protein').textContent = targets.protein;
                document.getElementById('target-carbs').textContent = targets.carbs;
                document.getElementById('target-fat').textContent = targets.fat;
                document.getElementById('target-fibre').textContent = targets.fibre;

                document.getElementById('clientTargets').innerHTML = `
                    <span class="target-item">${targets.kcal} kcal</span>
                    <span class="target-item">${targets.protein}P</span>
                    <span class="target-item">${targets.carbs}C</span>
                    <span class="target-item">${targets.fat}F</span>
                `;

                updateTotals();
            }
        }

        // Render food list
        function renderFoodList() {
            const foodList = document.getElementById('foodList');
            let filtered = foods;

            if (currentCategory !== 'all') {
                filtered = filtered.filter(f => f.category === currentCategory);
            }

            if (currentSearch) {
                const search = currentSearch.toLowerCase();
                filtered = filtered.filter(f => f.name.toLowerCase().includes(search));
            }

            if (filtered.length === 0) {
                foodList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No foods found</div>';
                return;
            }

            foodList.innerHTML = filtered.map(food => `
                <div class="food-card" draggable="true" data-food-id="${food.id}">
                    <div class="category-dot ${food.category}"></div>
                    <div class="food-info">
                        <div class="food-name">${food.name}</div>
                        <div class="food-macros">
                            <span class="macro-value p"><span>${food.protein || 0}</span>P</span>
                            <span class="macro-value c"><span>${food.carbs || 0}</span>C</span>
                            <span class="macro-value f"><span>${food.fat || 0}</span>F</span>
                        </div>
                    </div>
                </div>
            `).join('');

            // Add drag listeners
            document.querySelectorAll('.food-card').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });
        }

        // Drag handlers
        function handleDragStart(e) {
            draggedFood = foods.find(f => f.id === e.target.dataset.foodId);
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'copy';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
        }

        // Setup drop zones
        function setupDropZones() {
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                });

                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('drag-over');
                });

                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    targetMealIndex = parseInt(zone.dataset.meal);
                    openQuantityModal();
                });
            });
        }

        // Quantity Modal
        function openQuantityModal() {
            if (!draggedFood) return;
            
            document.getElementById('modalFoodName').textContent = draggedFood.name;
            document.getElementById('modalFoodInfo').textContent = `per 100g: ${draggedFood.kcal || 0} kcal`;
            document.getElementById('quantityInput').value = 100;
            updatePreview();
            document.getElementById('quantityModal').classList.add('active');
            document.getElementById('quantityInput').focus();
            document.getElementById('quantityInput').select();
        }

        function closeQuantityModal() {
            document.getElementById('quantityModal').classList.remove('active');
            draggedFood = null;
            targetMealIndex = null;
        }

        function updatePreview() {
            const qty = parseFloat(document.getElementById('quantityInput').value) || 0;
            const multiplier = qty / 100;
            
            document.getElementById('previewKcal').textContent = Math.round((draggedFood.kcal || 0) * multiplier) + ' kcal';
            document.getElementById('previewProtein').textContent = ((draggedFood.protein || 0) * multiplier).toFixed(1) + 'g';
            document.getElementById('previewCarbs').textContent = ((draggedFood.carbs || 0) * multiplier).toFixed(1) + 'g';
            document.getElementById('previewFat').textContent = ((draggedFood.fat || 0) * multiplier).toFixed(1) + 'g';
        }

        document.getElementById('quantityInput').addEventListener('input', updatePreview);

        function confirmAddFood() {
            const qty = parseFloat(document.getElementById('quantityInput').value) || 100;
            const multiplier = qty / 100;

            // Parse full_data if it exists
            let fullData = {};
            if (draggedFood.full_data) {
                try {
                    fullData = typeof draggedFood.full_data === 'string' ? JSON.parse(draggedFood.full_data) : draggedFood.full_data;
                } catch (e) {
                    fullData = {};
                }
            }

            const mealItem = {
                id: Date.now(),
                foodId: draggedFood.id,
                name: draggedFood.name,
                category: draggedFood.category,
                amount: qty,
                kcal: Math.round((draggedFood.kcal || 0) * multiplier),
                protein: parseFloat(((draggedFood.protein || 0) * multiplier).toFixed(1)),
                carbs: parseFloat(((draggedFood.carbs || 0) * multiplier).toFixed(1)),
                fat: parseFloat(((draggedFood.fat || 0) * multiplier).toFixed(1)),
                fibre: parseFloat(((draggedFood.fibre || 0) * multiplier).toFixed(1)),
                // Micros from full_data or direct fields
                iron: parseFloat(((parseFloat(fullData['Iron'] || draggedFood.iron) || 0) * multiplier).toFixed(2)),
                calcium: parseFloat(((parseFloat(fullData['Calcium'] || draggedFood.calcium) || 0) * multiplier).toFixed(1)),
                omega3: parseFloat(((parseFloat(fullData['Omega3(n-3)'] || draggedFood.omega3) || 0) * multiplier).toFixed(2)),
                vitaminD: parseFloat(((parseFloat(fullData['Vitamin D'] || 0) * multiplier).toFixed(2))),
                vitaminB12: parseFloat(((parseFloat(fullData['Vitamin B 12'] || 0) * multiplier).toFixed(2))),
                zinc: parseFloat(((parseFloat(fullData['Zinc'] || 0) * multiplier).toFixed(2))),
                magnesium: parseFloat(((parseFloat(fullData['Magnesium'] || 0) * multiplier).toFixed(1)))
            };

            mealPlans[currentDayType].meals[targetMealIndex].items.push(mealItem);
            renderMeals();
            updateTotals();
            closeQuantityModal();
        }

        // Add Meal
        function addMeal() {
            document.getElementById('mealNameInput').value = '';
            document.getElementById('mealTimeInput').value = '';
            document.getElementById('mealNameModal').classList.add('active');
            document.getElementById('mealNameInput').focus();
        }

        function closeMealNameModal() {
            document.getElementById('mealNameModal').classList.remove('active');
        }

        function confirmAddMeal() {
            const name = document.getElementById('mealNameInput').value.trim() || `Meal ${mealPlans[currentDayType].meals.length + 1}`;
            const time = document.getElementById('mealTimeInput').value || '';

            mealPlans[currentDayType].meals.push({
                name: name,
                time: time,
                items: []
            });

            renderMeals();
            closeMealNameModal();
        }

        // Render meals
        function renderMeals() {
            const container = document.getElementById('mealsContainer');
            const meals = mealPlans[currentDayType].meals;

            if (meals.length === 0) {
                container.innerHTML = `
                    <div class="empty-meals">
                        <div class="empty-meals-icon">üçΩ</div>
                        <h3 class="empty-meals-title">No meals yet</h3>
                        <p class="empty-meals-text">Click "Add Meal" to start building your meal plan</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = meals.map((meal, index) => {
                const mealTotals = meal.items.reduce((acc, item) => ({
                    kcal: acc.kcal + item.kcal,
                    protein: acc.protein + item.protein,
                    carbs: acc.carbs + item.carbs,
                    fat: acc.fat + item.fat
                }), { kcal: 0, protein: 0, carbs: 0, fat: 0 });

                return `
                    <div class="meal-card">
                        <div class="meal-header">
                            <div class="meal-title-section">
                                <span class="meal-title">${meal.name}</span>
                                ${meal.time ? `<span class="meal-time">${meal.time}</span>` : ''}
                            </div>
                            <div class="meal-totals">
                                <span class="macro-value"><span>${mealTotals.kcal}</span> kcal</span>
                                <span class="macro-value p"><span>${mealTotals.protein.toFixed(0)}</span>P</span>
                                <span class="macro-value c"><span>${mealTotals.carbs.toFixed(0)}</span>C</span>
                                <span class="macro-value f"><span>${mealTotals.fat.toFixed(0)}</span>F</span>
                            </div>
                            <div class="meal-actions">
                                <button class="meal-action-btn" onclick="deleteMeal(${index})">üóë</button>
                            </div>
                        </div>
                        ${meal.items.length > 0 ? `
                            <div class="meal-columns">
                                <div class="col-header col-food-header">Food</div>
                                <div class="col-header col-amount-header">Amount</div>
                                <div class="col-macros-header">
                                    <div class="col-macro-header p">Protein</div>
                                    <div class="col-macro-header c">Carbs</div>
                                    <div class="col-macro-header f">Fat</div>
                                </div>
                                <div class="col-action-header"></div>
                            </div>
                        ` : ''}
                        <div class="drop-zone" data-meal="${index}">
                            ${meal.items.length === 0 ? '<div class="drop-placeholder">Drag foods here</div>' : ''}
                            ${meal.items.map(item => `
                                <div class="meal-item">
                                    <div class="meal-item-food">
                                        <div class="category-dot ${item.category}"></div>
                                        <span class="meal-item-name">${item.name}</span>
                                    </div>
                                    <div class="meal-item-amount">${item.amount}g</div>
                                    <div class="meal-item-macros">
                                        <div class="meal-item-macro p">${item.protein}</div>
                                        <div class="meal-item-macro c">${item.carbs}</div>
                                        <div class="meal-item-macro f">${item.fat}</div>
                                    </div>
                                    <button class="remove-btn" onclick="removeItem(${index}, ${item.id})">‚úï</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            setupDropZones();
        }

        function removeItem(mealIndex, itemId) {
            mealPlans[currentDayType].meals[mealIndex].items = 
                mealPlans[currentDayType].meals[mealIndex].items.filter(item => item.id !== itemId);
            renderMeals();
            updateTotals();
        }

        function deleteMeal(index) {
            if (confirm('Delete this meal?')) {
                mealPlans[currentDayType].meals.splice(index, 1);
                renderMeals();
                updateTotals();
            }
        }

        // Update totals
        function updateTotals() {
            const allItems = mealPlans[currentDayType].meals.flatMap(m => m.items);

            const totals = allItems.reduce((acc, item) => ({
                kcal: acc.kcal + (item.kcal || 0),
                protein: acc.protein + (item.protein || 0),
                carbs: acc.carbs + (item.carbs || 0),
                fat: acc.fat + (item.fat || 0),
                fibre: acc.fibre + (item.fibre || 0),
                iron: acc.iron + (item.iron || 0),
                calcium: acc.calcium + (item.calcium || 0),
                omega3: acc.omega3 + (item.omega3 || 0),
                vitaminD: acc.vitaminD + (item.vitaminD || 0),
                vitaminB12: acc.vitaminB12 + (item.vitaminB12 || 0),
                zinc: acc.zinc + (item.zinc || 0),
                magnesium: acc.magnesium + (item.magnesium || 0)
            }), { kcal: 0, protein: 0, carbs: 0, fat: 0, fibre: 0, iron: 0, calcium: 0, omega3: 0, vitaminD: 0, vitaminB12: 0, zinc: 0, magnesium: 0 });

            // Update macro displays
            document.getElementById('total-kcal').textContent = totals.kcal.toLocaleString();
            document.getElementById('total-protein').textContent = totals.protein.toFixed(0);
            document.getElementById('total-carbs').textContent = totals.carbs.toFixed(0);
            document.getElementById('total-fat').textContent = totals.fat.toFixed(0);
            document.getElementById('total-fibre').textContent = totals.fibre.toFixed(0);

            // Update progress bars
            updateProgress('kcal', totals.kcal, targets.kcal);
            updateProgress('protein', totals.protein, targets.protein);
            updateProgress('carbs', totals.carbs, targets.carbs);
            updateProgress('fat', totals.fat, targets.fat);
            updateProgress('fibre', totals.fibre, targets.fibre);

            // Update micro grid
            updateMicros(totals);
        }

        function updateProgress(macro, current, target) {
            const percentage = Math.min((current / target) * 100, 110);
            const bar = document.getElementById(`progress-${macro}`);
            bar.style.width = percentage + '%';
            
            if (percentage > 105) {
                bar.classList.add('over');
            } else {
                bar.classList.remove('over');
            }
        }

        function updateMicros(totals) {
            const micros = [
                { key: 'iron', label: 'Iron', value: totals.iron, target: targets.iron, unit: 'mg' },
                { key: 'calcium', label: 'Calcium', value: totals.calcium, target: targets.calcium, unit: 'mg' },
                { key: 'omega3', label: 'Omega-3', value: totals.omega3, target: targets.omega3, unit: 'g' },
                { key: 'vitaminD', label: 'Vitamin D', value: totals.vitaminD, target: targets.vitaminD, unit: 'Œºg' },
                { key: 'vitaminB12', label: 'Vitamin B12', value: totals.vitaminB12, target: targets.vitaminB12, unit: 'Œºg' },
                { key: 'zinc', label: 'Zinc', value: totals.zinc, target: targets.zinc, unit: 'mg' },
                { key: 'magnesium', label: 'Magnesium', value: totals.magnesium, target: targets.magnesium, unit: 'mg' }
            ];

            document.getElementById('microGrid').innerHTML = micros.map(micro => {
                const percentage = (micro.value / micro.target) * 100;
                let status = 'low';
                if (percentage >= 90) status = 'good';
                else if (percentage >= 50) status = 'warning';

                return `
                    <div class="micro-item ${status}">
                        <div class="micro-label">${micro.label}</div>
                        <div class="micro-value">${micro.value.toFixed(1)}${micro.unit}</div>
                        <div class="micro-target">/ ${micro.target}${micro.unit}</div>
                    </div>
                `;
            }).join('');
        }

        // Day type management
        function openAddDayModal() {
            document.getElementById('addDayModal').classList.add('active');
        }

        function closeAddDayModal() {
            document.getElementById('addDayModal').classList.remove('active');
        }

        // Day type option selection
        document.querySelectorAll('.day-type-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.day-type-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedDayType = option.dataset.type;
            });
        });

        function confirmAddDay() {
            // Switch to the new day type
            switchDayType(selectedDayType);
            closeAddDayModal();
            updateDayTabs();
        }

        function switchDayType(type) {
            currentDayType = type;
            const dayInfo = dayTypes[type];
            document.getElementById('dayTitle').textContent = dayInfo.name;
            document.getElementById('dayTypeBadge').textContent = dayInfo.badge;
            
            // Update active tab
            document.querySelectorAll('.day-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.day === type);
            });

            renderMeals();
            updateTotals();
        }

        function updateDayTabs() {
            const tabs = document.getElementById('dayTabs');
            const activeDays = Object.keys(mealPlans).filter(type => 
                mealPlans[type].meals.length > 0 || type === currentDayType
            );

            let tabsHtml = activeDays.map(type => {
                const dayInfo = dayTypes[type];
                return `<button class="day-tab ${type === currentDayType ? 'active' : ''}" data-day="${type}" onclick="switchDayType('${type}')">${dayInfo.icon} ${dayInfo.name}</button>`;
            }).join('');

            tabsHtml += '<button class="add-day-btn" onclick="openAddDayModal()">+ Add Day Type</button>';
            tabs.innerHTML = tabsHtml;
        }

        // Clear day
        function clearDay() {
            if (confirm('Clear all meals for this day?')) {
                mealPlans[currentDayType].meals = [];
                renderMeals();
                updateTotals();
            }
        }

        // Copy day
        function copyDay() {
            alert('Copy day functionality coming soon');
        }

        // Save plan
        async function savePlan() {
            if (!selectedClientId) {
                alert('Please select a client first');
                return;
            }

            try {
                const planData = {
                    client_id: selectedClientId,
                    name: `${dayTypes[currentDayType].name} Plan`,
                    is_active: true,
                    meals: mealPlans[currentDayType]
                };

                const { error } = await supabaseClient
                    .from('meal_plans')
                    .insert([planData]);

                if (error) throw error;
                alert('Plan saved!');
            } catch (error) {
                console.error('Error saving plan:', error);
                alert('Error saving plan: ' + error.message);
            }
        }

        // Export plan
        function exportPlan() {
            alert('Export functionality coming soon');
        }

        // Category filters
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentCategory = btn.dataset.category;
                renderFoodList();
            });
        });

        // Search
        document.getElementById('foodSearch').addEventListener('input', (e) => {
            currentSearch = e.target.value;
            renderFoodList();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeQuantityModal();
                closeAddDayModal();
                closeMealNameModal();
            }
            if (e.key === 'Enter' && document.getElementById('quantityModal').classList.contains('active')) {
                confirmAddFood();
            }
        });

        // Initialize
        loadFoods();
        loadClients();
        renderMeals();
        updateTotals();
        updateDayTabs();
    </script>
</body>
</html>
